{% extends "base.html" %}

{% block title %}Dashboard - CloudNap{% endblock %}
{% block timezone %}{{ timezone }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-cloud"></i> CloudNap Dashboard
        </h1>
    </div>
</div>

<!-- Clusters Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-server"></i> Clusters
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#cronHelp" aria-expanded="false">
                        <i class="bi bi-question-circle"></i> Cron Help
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshClusters()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="collapse" id="cronHelp">
                <div class="card-body bg-light">
                    <h6><i class="bi bi-info-circle"></i> Cron Schedule Format</h6>
                    <p class="mb-2">Cron expressions use the format: <code>minute hour day month day-of-week</code></p>
                    <p class="mb-2"><i class="bi bi-clock"></i> <strong>Timezone:</strong> All schedules are executed in <code>{{ timezone }}</code> timezone.</p>
                    <p class="mb-2"><i class="bi bi-clock-history"></i> <strong>Current time:</strong> <span id="currentTime">{{ timezone }}</span></p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Common Examples:</strong>
                            <ul class="mb-0">
                                <li><code>0 8 * * 1-5</code> - Weekdays at 8:00 AM</li>
                                <li><code>0 18 * * 1-5</code> - Weekdays at 6:00 PM</li>
                                <li><code>0 2 * * 1</code> - Every Monday at 2:00 AM</li>
                                <li><code>0 0 1 * *</code> - First day of month at midnight</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Symbols:</strong>
                            <ul class="mb-0">
                                <li><code>*</code> - Any value</li>
                                <li><code>1-5</code> - Range (1 to 5)</li>
                                <li><code>0,6</code> - List (0 and 6)</li>
                                <li><code>*/15</code> - Every 15 units</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filtros y búsqueda -->
            <div class="card-body border-bottom">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="clusterSearch" placeholder="Buscar clusters por nombre...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-tags"></i></span>
                            <select class="form-select" id="tagFilter">
                                <option value="">Todos los tags</option>
                                <!-- Tags se llenarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-1" id="activeFilters">
                            <!-- Filtros activos se mostrarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="container mt-4">
                <!-- Contenedor con altura fija y scroll -->
                <div class="overflow-auto" style="max-height: 600px;">
                    <div class="row g-4">
                        {% if clusters %}
                            <div class="clusters-container">
                                <div class="row" id="clustersList">
                                    {% for cluster in clusters %}
                                    <div class="col-md-6 col-lg-4 mb-3 cluster-item" 
                                         data-cluster-name="{{ cluster.name|lower }}" 
                                         data-cluster-tags="{{ cluster.tags|join(',')|lower }}">
                                        <div class="card cluster-card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">{{ cluster.name }}</h6>
                                                <span class="badge bg-{{ 'success' if cluster.overall_status == 'running' else 'danger' if cluster.overall_status == 'stopped' else 'secondary' }}">
                                                    {{ cluster.overall_status.upper() }}
                                                </span>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text text-muted small">{{ cluster.description }}</p>
                                                
                                                <div class="mb-2">
                                                    <strong>Region:</strong> {{ cluster.region }}<br>
                                                    <strong>Instances:</strong> {{ cluster.instances|length }}<br>
                                                    <strong>Enabled:</strong> 
                                                    <span class="badge bg-{{ 'success' if cluster.enabled else 'secondary' }}">
                                                        {{ 'Yes' if cluster.enabled else 'No' }}
                                                    </span>
                                                </div>
                                                
                                                {% if cluster.tags %}
                                                <div class="mb-2">
                                                    {% for tag in cluster.tags %}
                                                    <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                                
                                                <div class="mb-2">
                                                    <strong>Instance Status:</strong>
                                                    <div class="mt-1 instance-statuses">
                                                        {% for instance in cluster.instances %}
                                                        <small class="d-block status-loading">
                                                            <i class="bi bi-circle-fill status-{{ instance.status.lower() if instance.status else 'unknown' }}"></i>
                                                            {{ instance.id }}: {{ instance.status or 'loading' }}
                                                        </small>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                
                                                {% if cluster.schedule %}
                                                <div class="mb-2">
                                                    <strong>Schedule:</strong>
                                                    <div class="mt-1">
                                                        <small class="text-muted mb-1 d-block">
                                                            <i class="bi bi-clock"></i> Timezone: <strong>{{ timezone }}</strong>
                                                        </small>
                                                        {% if cluster.schedule.wake_up %}
                                                        <small class="d-block">
                                                            <i class="bi bi-sunrise text-warning" title="Wake up schedule"></i>
                                                            <strong>Wake up:</strong> 
                                                            <code class="schedule-cron">{{ cluster.schedule.wake_up }}</code>
                                                            <i class="bi bi-info-circle text-muted schedule-info" 
                                                               data-cron="{{ cluster.schedule.wake_up }}" 
                                                               data-type="wake_up"
                                                               title="Click to see human readable description"></i>
                                                        </small>
                                                        {% endif %}
                                                        {% if cluster.schedule.shutdown %}
                                                        <small class="d-block">
                                                            <i class="bi bi-moon text-info" title="Shutdown schedule"></i>
                                                            <strong>Shutdown:</strong> 
                                                            <code class="schedule-cron">{{ cluster.schedule.shutdown }}</code>
                                                            <i class="bi bi-info-circle text-muted schedule-info" 
                                                               data-cron="{{ cluster.schedule.shutdown }}" 
                                                               data-type="shutdown"
                                                               title="Click to see human readable description"></i>
                                                        </small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="card-footer">
                                                <div class="btn-group w-100" role="group">
                                                    <button type="button" class="btn btn-success btn-sm cluster-action-btn" 
                                                            data-cluster="{{ cluster.name }}" 
                                                            data-action="start"
                                                            onclick="handleClusterAction(this, 'start', '{{ cluster.name }}')">
                                                        <i class="bi bi-play-fill"></i> <span class="btn-text">Start</span>
                                                        </button>
                                                    <button type="button" class="btn btn-danger btn-sm cluster-action-btn"
                                                            data-cluster="{{ cluster.name }}" 
                                                            data-action="stop"
                                                            onclick="handleClusterAction(this, 'stop', '{{ cluster.name }}')">
                                                        <i class="bi bi-stop-fill"></i> <span class="btn-text">Stop</span>
                                                        </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-server display-1"></i>
                                <p class="mt-3">No clusters configured</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduled Jobs Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock"></i> Scheduled Jobs
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshScheduledJobs()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            
            <!-- Filtros para Scheduled Jobs -->
            <div class="card-body border-bottom">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="jobSearch" placeholder="Buscar jobs por nombre...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-tags"></i></span>
                            <select class="form-select" id="jobTypeFilter">
                                <option value="">Todos los tipos</option>
                                <option value="wake_up">Wake Up</option>
                                <option value="shutdown">Shutdown</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-1" id="activeJobFilters">
                            <!-- Filtros activos se mostrarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if scheduled_jobs %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Name</th>
                                    <th>Next Run</th>
                                    <th>Trigger</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in scheduled_jobs %}
                                <tr class="job-item" 
                                    data-job-name="{{ job.name|lower }}" 
                                    data-job-type="{{ 'wake_up' if 'wake_up' in job.id else 'shutdown' if 'shutdown' in job.id else 'other' }}">
                                    <td><code>{{ job.id }}</code></td>
                                    <td>{{ job.name }}</td>
                                    <td>
                                        {% if job.next_run_time %}
                                            <span class="text-muted next-run-time" 
                                                  data-utc-time="{{ job.next_run_time }}"
                                                  data-bs-toggle="tooltip" 
                                                  data-bs-placement="top"
                                                  title="Click to see local time">
                                                {{ job.next_run_time }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">Not scheduled</span>
                                        {% endif %}
                                    </td>
                                    <td><small class="text-muted">{{ job.trigger }}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="triggerJob('{{ job.id }}')">
                                            <i class="bi bi-play-fill"></i> Run Now
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="bi bi-clock display-4"></i>
                        <p class="mt-3">No scheduled jobs</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Logs Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-journal-text"></i> Recent Logs
                </h5>
                <a href="{{ url_for('main.logs') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_logs %}
                    <div class="log-container" style="max-height: 300px; overflow-y: auto;">
                        {% for log in recent_logs %}
                        <div class="log-entry mb-1 p-2 bg-light rounded">
                            <small class="text-muted">{{ log.timestamp }}</small><br>
                            <code>{{ log.message }}</code>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="bi bi-journal-text display-4"></i>
                        <p class="mt-3">No recent logs</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CloudNap JavaScript Modules -->
<script src="{{ url_for('static', filename='js/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/clusters.js') }}"></script>
<script src="{{ url_for('static', filename='js/filters.js') }}"></script>
<script src="{{ url_for('static', filename='js/scheduler.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<!-- Template-specific configuration -->
<script>
// Set timezone for JavaScript modules
window.timezone = '{{ timezone }}';
</script>
{% endblock %}
